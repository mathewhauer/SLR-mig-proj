###------Figure MigPropensity-----
## @knitr MigPropensity

## Loading the SSPs and calculating median age
source("./R/SCRIPTS/007-FormatSSPs.R")
SSPs <- SSPs2 %>%
  filter(YEAR %in% c(2020, 2100)) %>%
  group_by(YEAR, AGE) %>%
  summarise(SSP2 = sum(SSP2)) %>%
  ungroup() %>%
  group_by(YEAR) %>%
  mutate(csum = cumsum(SSP2),
         tot = sum(SSP2),
         mid = if_else((csum/tot)<=0.5,1,0),
         midpoint = tot/2,
         medage = (midpoint-csum)/SSP2*5 + (AGE*5-5)) %>%
  filter(mid == 1) %>%
  filter(AGE == max(AGE))


## Pulling in the IPUMS Migration Data
agegrps <- seq(0,85,by =5)

# Migration data comes from IPUMS SDA portal
migdat_ipumssda <- tribble(
  ~"AGE", ~"Nonmover", ~"samestate", ~"difstate", ~"abroad", 
  1, 3043248, 695203, 124045, 25597, 
  2, 3153022, 687125, 116548, 27370, 
  3, 3276649, 649411, 109941, 24815, 
  4, 3400632, 633251, 101855, 24353, 
  5, 3328525, 593950, 95079, 23188, 
  6, 3418696, 539308, 88262, 20688, 
  7, 3507547, 520623, 84081, 21364, 
  8, 3558130, 489520, 79014, 20043, 
  9, 3542042, 472412, 76150, 19566, 
  10, 3592015, 447734, 69875, 19510, 
  11, 3589125, 431711, 68167, 16597, 
  12, 3634385, 418529, 66968, 17895, 
  13, 3664255, 410919, 63409, 17219, 
  14, 3686445, 399650, 63522, 18752, 
  15, 3714765, 393290, 58224, 19479, 
  16, 3727403, 383089, 59816, 24461, 
  17, 3688648, 397820, 58084, 26576, 
  18, 3325063, 851844, 281346, 47499, 
  19, 2952992, 944090, 256786, 47958, 
  20, 3368587, 1088281, 201375, 50170, 
  21, 3265150, 1108263, 187396, 56108, 
  22, 3109214, 1111211, 232530, 58340, 
  23, 2992610, 1114996, 257086, 60995, 
  24, 2949742, 1088356, 231612, 53218, 
  25, 3221432, 1117025, 240752, 57170, 
  26, 3115812, 1038250, 220034, 54267, 
  27, 3129271, 968908, 200806, 52832, 
  28, 3161268, 927594, 193968, 50373, 
  29, 3141994, 851704, 178070, 46135, 
  30, 3489191, 843558, 172540, 49607, 
  31, 3275320, 749166, 153904, 40917, 
  32, 3363999, 727815, 146119, 43139, 
  33, 3348002, 669400, 131938, 36732, 
  34, 3346089, 631811, 123301, 31835, 
  35, 3519223, 622605, 122152, 33912, 
  36, 3350677, 549560, 107597, 27911, 
  37, 3312732, 510895, 96283, 28378, 
  38, 3328941, 482325, 90754, 25909, 
  39, 3296798, 456366, 85239, 25143, 
  40, 3632141, 487479, 88816, 25659, 
  41, 3402388, 425676, 80717, 22810, 
  42, 3600483, 434599, 82452, 22775, 
  43, 3609077, 418375, 75562, 22057, 
  44, 3638272, 396374, 71683, 20182, 
  45, 3856148, 396303, 72693, 18197, 
  46, 3652248, 366326, 68666, 17915, 
  47, 3675148, 355774, 63275, 16238, 
  48, 3787711, 359625, 63275, 17125, 
  49, 3886263, 350836, 61443, 16119, 
  50, 4224519, 366345, 68001, 18730, 
  51, 3961680, 332357, 62857, 14522, 
  52, 4042855, 333879, 61588, 15259, 
  53, 4029316, 320232, 61662, 14613, 
  54, 4043768, 313400, 60493, 14397, 
  55, 4113196, 305292, 61684, 16437, 
  56, 3955679, 287665, 58841, 15044, 
  57, 3894542, 267628, 56720, 13685, 
  58, 3841598, 252492, 55562, 14092, 
  59, 3733376, 240386, 54901, 12899, 
  60, 3811766, 244232, 56325, 14092, 
  61, 3531166, 213771, 49441, 13540, 
  62, 3472501, 213304, 50173, 13980, 
  63, 3357492, 188632, 49571, 13265, 
  64, 3280550, 179586, 47345, 13040, 
  65, 3293931, 165771, 50019, 14412, 
  66, 3011867, 146070, 43789, 12689, 
  67, 2849291, 138773, 39150, 11381, 
  68, 2688290, 122683, 36956, 10900, 
  69, 2518566, 117459, 34531, 8666, 
  70, 2403724, 110256, 30298, 10360, 
  71, 2181811, 97693, 25847, 8057, 
  72, 2072924, 94630, 25125, 7335, 
  73, 1961666, 87572, 22619, 7416, 
  74, 1796083, 81708, 20525, 6611, 
  75, 1717542, 79198, 19224, 6300, 
  76, 1576501, 74274, 17431, 7059, 
  77, 1487474, 71856, 16692, 5424, 
  78, 1400931, 67411, 15707, 4668, 
  79, 1283134, 66557, 14456, 4975, 
  80, 1256466, 65667, 12933, 4101, 
  81, 1148947, 62794, 11939, 3538, 
  82, 1082572, 61740, 12866, 2932, 
  83, 1007146, 58484, 11515, 2978, 
  84, 939963, 57841, 11249, 2611, 
  85, 868478, 59774, 11088, 2847, 
  86, 779145, 54462, 10402, 2144, 
  87, 700659, 51582, 9552, 1996, 
  88, 606766, 50088, 8525, 1924, 
  89, 483592, 38440, 6518, 1119, 
  90, 325755, 27014, 4514, 661, 
  91, 127377, 10746, 1912, 359, 
  92, 231946, 19988, 3891, 597, 
  93, 458664, 40256, 7334, 917, 
  94, 759061, 75289, 10083, 1696, 
  95, 168051, 15217, 2007, 252, 
  96, 5527, 665, 59, 0, 
  97, 1283, 5, 0, 0) %>%
  mutate(AGEGRP = findInterval(AGE, agegrps),
         probmig = 1- (Nonmover / (samestate+difstate+abroad+Nonmover)))

year2020 <- filter(SSPs, YEAR==2020)
year2100 <- filter(SSPs, YEAR ==2100)

ggplot(data = migdat_ipumssda) +
  geom_line(aes(x = AGE, y = probmig), group=1) +
  geom_point(aes(x = findInterval(year2020$medage, migdat_ipumssda$AGE), y = migdat_ipumssda$probmig[which(migdat_ipumssda$AGE == findInterval(year2020$medage, migdat_ipumssda$AGE) )]), color = "black", size =2) +
  geom_point(aes(x = findInterval(year2100$medage, migdat_ipumssda$AGE), y = migdat_ipumssda$probmig[which(migdat_ipumssda$AGE == findInterval(year2100$medage, migdat_ipumssda$AGE) )]), color = "black", size =2) +
  annotate("text", x = 48, y = .21, label = paste0("2020: ",round(year2020$medage, 1)," years") , col = "black", size = 2) +
  annotate("text", x = 58, y = .12, label = paste0("2100: ",round(year2100$medage, 1)," years"), col = "black", size = 2) +
  scale_x_continuous(limits = c(0,96), expand = c(0, 0)) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +
  # gganimate::transition_time(YEAR) +
  labs(x = "Age",
       y = "Probability of Migration")

ggsave("./MANUSCRIPT/MainDocument/FigProbMig.pdf", width = 3.42, height=2.42)
